.PHONY: help run build test clean migrate seed docker-up docker-down

# Variables
APP_NAME=pilates-api
MAIN_PATH=cmd/server/main.go
BUILD_DIR=bin
GO=go
GOFLAGS=-v

# Default target
help: ## Show this help message
	@echo "ğŸ“‹ Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# Development
run: ## Run the application in development mode
	@echo "ğŸš€ Starting server..."
	$(GO) run $(MAIN_PATH)

dev: ## Run with hot reload (requires air)
	@echo "ğŸ”¥ Starting with hot reload..."
	air

# Build
build: ## Build the application
	@echo "ğŸ”¨ Building $(APP_NAME)..."
	@mkdir -p $(BUILD_DIR)
	$(GO) build $(GOFLAGS) -o $(BUILD_DIR)/$(APP_NAME) $(MAIN_PATH)
	@echo "âœ… Build complete: $(BUILD_DIR)/$(APP_NAME)"

build-linux: ## Build for Linux
	@echo "ğŸ§ Building for Linux..."
	@mkdir -p $(BUILD_DIR)
	GOOS=linux GOARCH=amd64 $(GO) build $(GOFLAGS) -o $(BUILD_DIR)/$(APP_NAME)-linux $(MAIN_PATH)
	@echo "âœ… Linux build complete"

build-windows: ## Build for Windows
	@echo "ğŸªŸ Building for Windows..."
	@mkdir -p $(BUILD_DIR)
	GOOS=windows GOARCH=amd64 $(GO) build $(GOFLAGS) -o $(BUILD_DIR)/$(APP_NAME).exe $(MAIN_PATH)
	@echo "âœ… Windows build complete"

build-mac: ## Build for macOS
	@echo "ğŸ Building for macOS..."
	@mkdir -p $(BUILD_DIR)
	GOOS=darwin GOARCH=amd64 $(GO) build $(GOFLAGS) -o $(BUILD_DIR)/$(APP_NAME)-mac $(MAIN_PATH)
	@echo "âœ… macOS build complete"

build-all: build-linux build-windows build-mac ## Build for all platforms
	@echo "âœ… All builds complete"

# Testing
test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	$(GO) test -v ./...

test-coverage: ## Run tests with coverage
	@echo "ğŸ“Š Running tests with coverage..."
	$(GO) test -v -coverprofile=coverage.out ./...
	$(GO) tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report: coverage.html"

# Database
db-create: ## Create database
	@echo "ğŸ—„ï¸ Creating database..."
	psql -U postgres -c "CREATE DATABASE pilates_db;"
	@echo "âœ… Database created"

db-drop: ## Drop database
	@echo "ğŸ—‘ï¸ Dropping database..."
	psql -U postgres -c "DROP DATABASE IF EXISTS pilates_db;"
	@echo "âœ… Database dropped"

db-reset: db-drop db-create ## Reset database (drop and create)
	@echo "âœ… Database reset complete"

migrate: ## Run migrations
	@echo "ğŸ”„ Running migrations..."
	$(GO) run $(MAIN_PATH)

seed: ## Seed database
	@echo "ğŸŒ± Seeding database..."
	@# Seeding happens automatically on startup

# Docker
docker-build: ## Build Docker image
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(APP_NAME):latest .
	@echo "âœ… Docker image built"

docker-run: ## Run Docker container
	@echo "ğŸ³ Running Docker container..."
	docker run -p 8080:8080 --env-file .env $(APP_NAME):latest

docker-up: ## Start services with docker-compose
	@echo "ğŸ³ Starting services..."
	docker-compose up -d
	@echo "âœ… Services started"

docker-down: ## Stop services with docker-compose
	@echo "ğŸ›‘ Stopping services..."
	docker-compose down
	@echo "âœ… Services stopped"

docker-logs: ## View docker logs
	docker-compose logs -f

# Dependencies
deps: ## Download dependencies
	@echo "ğŸ“¦ Downloading dependencies..."
	$(GO) mod download
	@echo "âœ… Dependencies downloaded"

deps-tidy: ## Tidy dependencies
	@echo "ğŸ§¹ Tidying dependencies..."
	$(GO) mod tidy
	@echo "âœ… Dependencies tidied"

deps-update: ## Update dependencies
	@echo "â¬†ï¸ Updating dependencies..."
	$(GO) get -u ./...
	$(GO) mod tidy
	@echo "âœ… Dependencies updated"

# Cleaning
clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning..."
	rm -rf $(BUILD_DIR)
	rm -f coverage.out coverage.html
	@echo "âœ… Clean complete"

clean-all: clean ## Clean everything including dependencies
	@echo "ğŸ§¹ Deep cleaning..."
	$(GO) clean -modcache
	@echo "âœ… Deep clean complete"

# Code quality
fmt: ## Format code
	@echo "âœ¨ Formatting code..."
	$(GO) fmt ./...
	@echo "âœ… Code formatted"

lint: ## Run linter
	@echo "ğŸ” Running linter..."
	golangci-lint run
	@echo "âœ… Linting complete"

vet: ## Run go vet
	@echo "ğŸ” Running go vet..."
	$(GO) vet ./...
	@echo "âœ… Vet complete"

# Installation
install-tools: ## Install development tools
	@echo "ğŸ”§ Installing development tools..."
	go install github.com/cosmtrek/air@latest
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "âœ… Tools installed"

# Production
prod-build: ## Build for production
	@echo "ğŸ­ Building for production..."
	@mkdir -p $(BUILD_DIR)
	CGO_ENABLED=0 GOOS=linux $(GO) build -a -installsuffix cgo -ldflags="-w -s" -o $(BUILD_DIR)/$(APP_NAME) $(MAIN_PATH)
	@echo "âœ… Production build complete"

# Quick commands
start: run ## Alias for run
stop: ## Stop running processes
	@echo "ğŸ›‘ Stopping..."
	@pkill -f $(APP_NAME) || true
	@echo "âœ… Stopped"

restart: stop run ## Restart the application

# Information
info: ## Show project information
	@echo "ğŸ“‹ Project Information"
	@echo "  Name: $(APP_NAME)"
	@echo "  Go Version: $(shell $(GO) version)"
	@echo "  Build Dir: $(BUILD_DIR)"
	@echo "  Main Path: $(MAIN_PATH)"